/**
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 */

import{addClassNamesToElement as t,isHTMLAnchorElement as e}from"@lexical/utils";import{createCommand as r,ElementNode as n,$isRangeSelection as i,$applyNodeReplacement as l,$isElementNode as s,$getSelection as u}from"lexical";const _=new Set(["http:","https:","mailto:","sms:","tel:"]);class o extends n{static getType(){return"link"}static clone(t){return new o(t.__url,{rel:t.__rel,target:t.__target,title:t.__title},t.__key)}constructor(t,e={},r){super(r);const{target:n=null,rel:i=null,title:l=null}=e;this.__url=t,this.__target=n,this.__rel=i,this.__title=l}createDOM(e){const r=document.createElement("a");return r.href=this.sanitizeUrl(this.__url),null!==this.__target&&(r.target=this.__target),null!==this.__rel&&(r.rel=this.__rel),null!==this.__title&&(r.title=this.__title),t(r,e.theme.link),r}updateDOM(t,e,r){if(e instanceof HTMLAnchorElement){const r=this.__url,n=this.__target,i=this.__rel,l=this.__title;r!==t.__url&&(e.href=r),n!==t.__target&&(n?e.target=n:e.removeAttribute("target")),i!==t.__rel&&(i?e.rel=i:e.removeAttribute("rel")),l!==t.__title&&(l?e.title=l:e.removeAttribute("title"))}return!1}static importDOM(){return{a:t=>({conversion:a,priority:1})}}static importJSON(t){const e=c(t.url,{rel:t.rel,target:t.target,title:t.title});return e.setFormat(t.format),e.setIndent(t.indent),e.setDirection(t.direction),e}sanitizeUrl(t){try{const e=new URL(t);if(!_.has(e.protocol))return"about:blank"}catch(e){return t}return t}exportJSON(){return{...super.exportJSON(),rel:this.getRel(),target:this.getTarget(),title:this.getTitle(),type:"link",url:this.getURL(),version:1}}getURL(){return this.getLatest().__url}setURL(t){this.getWritable().__url=t}getTarget(){return this.getLatest().__target}setTarget(t){this.getWritable().__target=t}getRel(){return this.getLatest().__rel}setRel(t){this.getWritable().__rel=t}getTitle(){return this.getLatest().__title}setTitle(t){this.getWritable().__title=t}insertNewAfter(t,e=!0){const r=c(this.__url,{rel:this.__rel,target:this.__target,title:this.__title});return this.insertAfter(r,e),r}canInsertTextBefore(){return!1}canInsertTextAfter(){return!1}canBeEmpty(){return!1}isInline(){return!0}extractWithChild(t,e,r){if(!i(e))return!1;const n=e.anchor.getNode(),l=e.focus.getNode();return this.isParentOf(n)&&this.isParentOf(l)&&e.getTextContent().length>0}}function a(t){let r=null;if(e(t)){const e=t.textContent;(null!==e&&""!==e||t.children.length>0)&&(r=c(t.getAttribute("href")||"",{rel:t.getAttribute("rel"),target:t.getAttribute("target"),title:t.getAttribute("title")}))}return{node:r}}function c(t,e){return l(new o(t,e))}function g(t){return t instanceof o}class h extends o{constructor(t,e={},r){super(t,e,r),this.__isUnlinked=void 0!==e.isUnlinked&&null!==e.isUnlinked&&e.isUnlinked}static getType(){return"autolink"}static clone(t){return new h(t.__url,{isUnlinked:t.__isUnlinked,rel:t.__rel,target:t.__target,title:t.__title},t.__key)}getIsUnlinked(){return this.__isUnlinked}setIsUnlinked(t){const e=this.getWritable();return e.__isUnlinked=t,e}createDOM(t){return this.__isUnlinked?document.createElement("span"):super.createDOM(t)}updateDOM(t,e,r){return super.updateDOM(t,e,r)||t.__isUnlinked!==this.__isUnlinked}static importJSON(t){const e=f(t.url,{isUnlinked:t.isUnlinked,rel:t.rel,target:t.target,title:t.title});return e.setFormat(t.format),e.setIndent(t.indent),e.setDirection(t.direction),e}static importDOM(){return null}exportJSON(){return{...super.exportJSON(),isUnlinked:this.__isUnlinked,type:"autolink",version:1}}insertNewAfter(t,e=!0){const r=this.getParentOrThrow().insertNewAfter(t,e);if(s(r)){const t=f(this.__url,{isUnlinked:this.__isUnlinked,rel:this.__rel,target:this.__target,title:this.__title});return r.append(t),t}return null}}function f(t,e){return l(new h(t,e))}function d(t){return t instanceof h}const p=r("TOGGLE_LINK_COMMAND");function k(t,e={}){const{target:r,title:n}=e,l=void 0===e.rel?"noreferrer":e.rel,_=u();if(!i(_))return;const o=_.extract();if(null===t)o.forEach((t=>{const e=t.getParent();if(!d(e)&&g(e)){const t=e.getChildren();for(let r=0;r<t.length;r++)e.insertBefore(t[r]);e.remove()}}));else{if(1===o.length){const e=function(t,e){let r=t;for(;null!==r&&null!==r.getParent()&&!e(r);)r=r.getParentOrThrow();return e(r)?r:null}(o[0],g);if(null!==e)return e.setURL(t),void 0!==r&&e.setTarget(r),null!==l&&e.setRel(l),void(void 0!==n&&e.setTitle(n))}let e=null,i=null;o.forEach((u=>{const _=u.getParent();if(_!==i&&null!==_&&(!s(u)||u.isInline())){if(g(_))return i=_,_.setURL(t),void 0!==r&&_.setTarget(r),null!==l&&i.setRel(l),void(void 0!==n&&i.setTitle(n));if(_.is(e)||(e=_,i=c(t,{rel:l,target:r,title:n}),g(_)?null===u.getPreviousSibling()?_.insertBefore(i):_.insertAfter(i):u.insertBefore(i)),g(u)){if(u.is(i))return;if(null!==i){const t=u.getChildren();for(let e=0;e<t.length;e++)i.append(t[e])}u.remove()}else null!==i&&i.append(u)}}))}}const U=k;export{f as $createAutoLinkNode,c as $createLinkNode,d as $isAutoLinkNode,g as $isLinkNode,k as $toggleLink,h as AutoLinkNode,o as LinkNode,p as TOGGLE_LINK_COMMAND,U as toggleLink};
