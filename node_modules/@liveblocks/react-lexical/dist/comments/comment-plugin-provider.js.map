{"version":3,"file":"comment-plugin-provider.js","sources":["../../src/comments/comment-plugin-provider.tsx"],"sourcesContent":["import { useLexicalComposerContext } from \"@lexical/react/LexicalComposerContext\";\nimport {\n  addClassNamesToElement,\n  registerNestedElementResolver,\n  removeClassNamesFromElement,\n} from \"@lexical/utils\";\nimport { shallow } from \"@liveblocks/core\";\nimport {\n  CreateThreadError,\n  getUmbrellaStoreForClient,\n  selectThreads,\n  useClient,\n  useCommentsErrorListener,\n  useRoom,\n} from \"@liveblocks/react\";\nimport type { BaseSelection, NodeKey, NodeMutation } from \"lexical\";\nimport {\n  $getNodeByKey,\n  $getSelection,\n  $isRangeSelection,\n  $isTextNode,\n} from \"lexical\";\nimport type { PropsWithChildren } from \"react\";\nimport * as React from \"react\";\nimport { createContext, useCallback, useEffect, useState } from \"react\";\nimport { useSyncExternalStoreWithSelector } from \"use-sync-external-store/shim/with-selector.js\";\n\nimport $getThreadMarkIds from \"./get-thread-mark-ids\";\nimport {\n  $createThreadMarkNode,\n  $isThreadMarkNode,\n  ThreadMarkNode,\n} from \"./thread-mark-node\";\nimport $unwrapThreadMarkNode from \"./unwrap-thread-mark-node\";\n\nexport const OnDeleteThreadCallback = createContext<\n  ((threadId: string) => void) | null\n>(null);\n\nexport const ActiveThreadsContext = createContext<string[] | null>(null);\n\nexport const IsActiveThreadContext = createContext<\n  ((threadId: string) => boolean) | null\n>(null);\n\nexport type ThreadToNodesMap = Map<string, Set<NodeKey>>;\n\nexport const ThreadToNodesContext = createContext<ThreadToNodesMap | null>(\n  null\n);\n\nexport function CommentPluginProvider({ children }: PropsWithChildren) {\n  const [editor, context] = useLexicalComposerContext();\n\n  const [threadToNodes, setThreadToNodes] = useState<ThreadToNodesMap>(\n    new Map()\n  ); // A map from thread id to a set of (thread mark) node keys that are associated with the thread\n\n  const [activeThreads, setActiveThreads] = useState<string[]>([]); // The threads that are currently active (or selected) in the editor\n\n  const client = useClient();\n\n  const room = useRoom();\n\n  const isThreadActive = useCallback(\n    (threadId: string) => {\n      return activeThreads.includes(threadId);\n    },\n    [activeThreads]\n  );\n\n  /**\n   * Remove the thread id from the associated nodes and unwrap the nodes if they are no longer associated with any threads.\n   * @param threadId The id of the thread to remove\n   */\n  const handleThreadDelete = useCallback(\n    (threadId: string) => {\n      editor.update(() => {\n        // Retrieve node keys associated with the thread\n        const keys = threadToNodes.get(threadId);\n        if (keys === undefined) return;\n\n        // Iterate over each thread node and disassociate the thread if from the node and unwrap the node if it is no longer associated with any threads\n        for (const key of keys) {\n          const node = $getNodeByKey(key);\n          if (!$isThreadMarkNode(node)) continue;\n          node.deleteID(threadId);\n\n          if (node.getIDs().length === 0) {\n            $unwrapThreadMarkNode(node);\n          }\n        }\n      });\n    },\n    [editor, threadToNodes]\n  );\n\n  useCommentsErrorListener((error) => {\n    // If thread creation fails, we remove the thread id from the associated nodes and unwrap the nodes if they are no longer associated with any threads\n    if (error instanceof CreateThreadError) {\n      handleThreadDelete(error.context.threadId);\n    }\n  });\n\n  const store = getUmbrellaStoreForClient(client);\n\n  const roomId = room.id;\n  const threads = useSyncExternalStoreWithSelector(\n    store.subscribeThreads,\n    store.getThreads,\n    store.getThreads,\n    useCallback(\n      () =>\n        selectThreads(store.getThreads(), {\n          roomId,\n          orderBy: \"age\",\n          query: {\n            resolved: false,\n          },\n        }).map((thread) => thread.id),\n      [roomId, store]\n    ),\n    shallow\n  );\n\n  /**\n   * Only add styles to the thread mark elements that currently have threads associated with them.\n   */\n  useEffect(() => {\n    function getThreadMarkElements() {\n      const activeElements = new Set<HTMLElement>();\n\n      for (const id of threads) {\n        const keys = threadToNodes.get(id);\n        if (keys === undefined) continue;\n\n        for (const key of keys) {\n          const element = editor.getElementByKey(key);\n          if (element === null) continue;\n          activeElements.add(element);\n        }\n      }\n      return activeElements;\n    }\n\n    const elements = getThreadMarkElements();\n\n    const theme = context.getTheme();\n\n    const classNames = [\"lb-root\", \"lb-lexical-thread-mark\"];\n    if (theme && theme.liveblocks && \"threadMark\" in theme.liveblocks) {\n      classNames.push((theme.liveblocks as { threadMark: string }).threadMark);\n    }\n\n    elements.forEach((element) => {\n      addClassNamesToElement(element, ...classNames);\n    });\n\n    return () => {\n      elements.forEach((element) => {\n        removeClassNamesFromElement(element, ...classNames);\n      });\n    };\n  }, [context, editor, threadToNodes, threads]);\n\n  /**\n   * Register a mutation listener that listens for mutations on 'ThreadMarkNode's and updates the map of thread to node keys accordingly.\n   */\n  useEffect(() => {\n    function onMutation(mutations: Map<string, NodeMutation>) {\n      const state = editor.getEditorState();\n      setThreadToNodes((prev) => {\n        const updatedMap = new Map(prev);\n        state.read(() => {\n          for (const [key, mutation] of mutations) {\n            // If the node is destroyed, we remove its key from the map of thread to node keys\n            if (mutation === \"destroyed\") {\n              for (const [, nodes] of updatedMap) {\n                nodes.delete(key);\n              }\n            }\n            // Otherwise, if a new node is created or an existing node is updated, we update the map of thread to node keys to include the new/updated node\n            else if (mutation === \"created\" || mutation === \"updated\") {\n              const node = $getNodeByKey(key);\n              if (!$isThreadMarkNode(node)) continue;\n\n              const threadIds = node.getIDs();\n\n              for (const id of threadIds) {\n                const keys = updatedMap.get(id) ?? new Set();\n                keys.add(key);\n                updatedMap.set(id, keys);\n              }\n            }\n          }\n        });\n        return updatedMap;\n      });\n    }\n\n    return editor.registerMutationListener(ThreadMarkNode, onMutation);\n  }, [editor]);\n\n  /**\n   * Register an update listener that listens for changes in the selection and updates the active threads accordingly.\n   */\n  useEffect(() => {\n    function $getThreadIds(selection: BaseSelection | null): string[] {\n      if (selection === null) return [];\n\n      if (!$isRangeSelection(selection)) return [];\n\n      const anchor = selection.anchor.getNode();\n      if (!$isTextNode(anchor)) return [];\n\n      return $getThreadMarkIds(anchor, selection.anchor.offset) ?? [];\n    }\n\n    function $onStateRead() {\n      const selection = $getSelection();\n\n      const threadIds = $getThreadIds(selection).filter((id) => {\n        return selectThreads(store.getThreads(), {\n          roomId,\n          orderBy: \"age\",\n          query: {\n            resolved: false,\n          },\n        }).some((thread) => thread.id === id);\n      });\n      setActiveThreads(threadIds);\n    }\n\n    const unsubscribeCache = store.subscribeThreads(() => {\n      editor.getEditorState().read($onStateRead);\n    });\n\n    const unregisterUpdateListener = editor.registerUpdateListener(\n      ({ editorState: state }) => {\n        state.read($onStateRead);\n      }\n    );\n\n    return () => {\n      unregisterUpdateListener();\n      unsubscribeCache();\n    };\n  }, [editor, client, roomId, store]);\n\n  /**\n   * When active threads change, we add a data-state attribute and set it to \"active\" for all HTML elements that are associated with the active threads.\n   */\n  useEffect(() => {\n    function getActiveElements() {\n      const activeElements = new Set<HTMLElement>();\n\n      for (const thread of activeThreads) {\n        const keys = threadToNodes.get(thread);\n        if (keys === undefined) continue;\n\n        for (const key of keys) {\n          const element = editor.getElementByKey(key);\n          if (element === null) continue;\n          activeElements.add(element);\n        }\n      }\n      return activeElements;\n    }\n\n    const activeElements = getActiveElements();\n\n    activeElements.forEach((element) => {\n      element.setAttribute(\"data-state\", \"active\");\n    });\n\n    return () => {\n      activeElements.forEach((element) => {\n        element.removeAttribute(\"data-state\");\n      });\n    };\n  }, [activeThreads, editor, threadToNodes]);\n\n  useEffect(() => {\n    return registerNestedElementResolver<ThreadMarkNode>(\n      editor,\n      ThreadMarkNode,\n      (from: ThreadMarkNode) => {\n        return $createThreadMarkNode(from.getIDs());\n      },\n      (from: ThreadMarkNode, to: ThreadMarkNode) => {\n        const ids = from.getIDs();\n        ids.forEach((id) => {\n          to.addID(id);\n        });\n      }\n    );\n  }, [editor]);\n\n  return (\n    <OnDeleteThreadCallback.Provider value={handleThreadDelete}>\n      <ActiveThreadsContext.Provider value={activeThreads}>\n        <IsActiveThreadContext.Provider value={isThreadActive}>\n          <ThreadToNodesContext.Provider value={threadToNodes}>\n            {children}\n          </ThreadToNodesContext.Provider>\n        </IsActiveThreadContext.Provider>\n      </ActiveThreadsContext.Provider>\n    </OnDeleteThreadCallback.Provider>\n  );\n}\n\n/**\n * Returns whether the associated thread annotation for the given thread id is selected or not in the editor.\n * @param threadId The id of the thread to check if the associated annotation is selected or not.\n * @returns true if the associated annotation for the thread is selected, false otherwise.\n */\nexport function useIsThreadActive(threadId: string): boolean {\n  const isActive = React.useContext(IsActiveThreadContext);\n  if (isActive === null) {\n    throw new Error(\n      \"useIsThreadActive must be used within LiveblocksPlugin. For more information: https://liveblocks.io/docs/api-reference/liveblocks-react-lexical#useIsThreadActive\"\n    );\n  }\n\n  return isActive(threadId);\n}\n"],"names":["createContext","useLexicalComposerContext","useState","useClient","useRoom","useCallback","$getNodeByKey","$isThreadMarkNode","$unwrapThreadMarkNode","useCommentsErrorListener","CreateThreadError","getUmbrellaStoreForClient","useSyncExternalStoreWithSelector","selectThreads","shallow","useEffect","addClassNamesToElement","removeClassNamesFromElement","ThreadMarkNode","$isRangeSelection","$isTextNode","$getThreadMarkIds","$getSelection","activeElements","registerNestedElementResolver","$createThreadMarkNode","React"],"mappings":"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"}