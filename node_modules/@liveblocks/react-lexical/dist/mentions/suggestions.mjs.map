{"version":3,"file":"suggestions.mjs","sources":["../../src/mentions/suggestions.tsx"],"sourcesContent":["import { useLexicalComposerContext } from \"@lexical/react/LexicalComposerContext\";\nimport {\n  COMMAND_PRIORITY_LOW,\n  KEY_ARROW_DOWN_COMMAND,\n  KEY_ARROW_UP_COMMAND,\n  KEY_ENTER_COMMAND,\n  KEY_ESCAPE_COMMAND,\n} from \"lexical\";\nimport type {\n  Dispatch,\n  HTMLAttributes,\n  MouseEvent,\n  ReactNode,\n  SetStateAction,\n} from \"react\";\nimport React, {\n  createContext,\n  forwardRef,\n  useContext,\n  useEffect,\n  useImperativeHandle,\n  useRef,\n  useState,\n} from \"react\";\n\nexport const SuggestionsContext = createContext<string[] | null>(null);\n\nexport const OnValueSelectCallbackContext = createContext<\n  ((value: string) => void) | null\n>(null);\n\nexport const OnResetMatchCallbackContext = createContext<(() => void) | null>(\n  null\n);\n\nconst HighlightedIndexContext = createContext<\n  [number, Dispatch<SetStateAction<number>>] | null\n>(null);\n\nexport interface ListProps extends HTMLAttributes<HTMLDivElement> {\n  children: ReactNode;\n}\n\nconst List = forwardRef<HTMLDivElement, ListProps>(\n  function (props, forwardedRef) {\n    const { children, ...divProps } = props;\n    const [editor] = useLexicalComposerContext();\n    const [highlightedIndex, setHighlightedIndex] = useState(0);\n    const values = useSuggestions();\n    const onValueSelect = useOnValueSelectCallback();\n    const onEscapeKeyDown = useOnResetMatchCallback();\n\n    useEffect(() => {\n      function onKeyArrowDown(event: KeyboardEvent): boolean {\n        if (values.length === 0) return true;\n        if (highlightedIndex === null) return true;\n\n        // If the highlighted index is at the last suggestion, then we loop back to the first suggestion, otherwise we increment the index.\n        const nextIndex =\n          highlightedIndex === values.length - 1 ? 0 : highlightedIndex + 1;\n        setHighlightedIndex(nextIndex);\n\n        event.preventDefault();\n        event.stopImmediatePropagation();\n\n        return true;\n      }\n\n      return editor.registerCommand(\n        KEY_ARROW_DOWN_COMMAND,\n        onKeyArrowDown,\n        COMMAND_PRIORITY_LOW\n      );\n    }, [editor, highlightedIndex, values]);\n\n    useEffect(() => {\n      function onKeyArrowUp(event: KeyboardEvent): boolean {\n        if (values.length === 0) return true;\n        if (highlightedIndex === null) return true;\n\n        // If the highlighted index is at the first suggestion, then we loop back to the last suggestion, otherwise we decrement the index.\n        const nextIndex =\n          highlightedIndex === 0 ? values.length - 1 : highlightedIndex - 1;\n        setHighlightedIndex(nextIndex);\n\n        event.preventDefault();\n        event.stopImmediatePropagation();\n        return true;\n      }\n\n      return editor.registerCommand(\n        KEY_ARROW_UP_COMMAND,\n        onKeyArrowUp,\n        COMMAND_PRIORITY_LOW\n      );\n    }, [editor, highlightedIndex, values]);\n\n    useEffect(() => {\n      function onKeyEscape(event: KeyboardEvent): boolean {\n        event.preventDefault();\n        event.stopImmediatePropagation();\n\n        onEscapeKeyDown();\n        return true;\n      }\n\n      return editor.registerCommand<KeyboardEvent>(\n        KEY_ESCAPE_COMMAND,\n        onKeyEscape,\n        COMMAND_PRIORITY_LOW\n      );\n    }, [editor, onEscapeKeyDown]);\n\n    useEffect(() => {\n      function onKeyEnter(event: KeyboardEvent | null): boolean {\n        if (values.length === 0) return true;\n\n        onValueSelect(values[highlightedIndex]);\n\n        if (event === null) return true;\n\n        event.preventDefault();\n        event.stopImmediatePropagation();\n        return true;\n      }\n\n      return editor.registerCommand(\n        KEY_ENTER_COMMAND,\n        onKeyEnter,\n        COMMAND_PRIORITY_LOW\n      );\n    }, [editor, onValueSelect, highlightedIndex, values]);\n\n    useEffect(() => {\n      const root = editor.getRootElement();\n      if (root === null) return;\n\n      root.setAttribute(\n        \"aria-activedescendant\",\n        `typeahead-item-${highlightedIndex}`\n      );\n\n      return () => {\n        root.removeAttribute(\"aria-activedescendant\");\n      };\n    }, [editor, highlightedIndex]);\n\n    return (\n      <HighlightedIndexContext.Provider\n        value={[highlightedIndex, setHighlightedIndex]}\n      >\n        <div role=\"listbox\" {...divProps} ref={forwardedRef}>\n          {children}\n        </div>\n      </HighlightedIndexContext.Provider>\n    );\n  }\n);\n\ninterface ItemProps extends HTMLAttributes<HTMLDivElement> {\n  value: string;\n}\n\nconst Item = forwardRef<HTMLDivElement | null, ItemProps>(\n  function Item(props, forwardedRef) {\n    const { children, value, onMouseEnter, onClick, ...divProps } = props;\n    const divRef = useRef<HTMLDivElement>(null);\n\n    const [highlightedIndex, setHighlightedIndex] = useHighlightedIndex();\n    const suggestions = useSuggestions();\n    const onValueSelect = useOnValueSelectCallback();\n\n    const isHighlighted = suggestions[highlightedIndex] === value;\n\n    useImperativeHandle<HTMLDivElement | null, HTMLDivElement | null>(\n      forwardedRef,\n      () => divRef.current\n    );\n\n    useEffect(() => {\n      if (!isHighlighted) return;\n\n      const div = divRef.current;\n      if (div === null) return;\n\n      div.scrollIntoView({ block: \"nearest\" });\n    }, [isHighlighted]);\n\n    function handleMouseEnter(event: MouseEvent<HTMLDivElement>) {\n      onMouseEnter?.(event);\n\n      if (event.isDefaultPrevented()) return;\n\n      const index = suggestions.indexOf(value);\n      if (index === -1) return;\n\n      setHighlightedIndex(index);\n    }\n\n    function handleClick(event: MouseEvent<HTMLDivElement>) {\n      onClick?.(event);\n\n      if (event.isDefaultPrevented()) return;\n\n      onValueSelect(value);\n    }\n\n    return (\n      <div\n        role=\"option\"\n        data-highlighted={isHighlighted || undefined}\n        onMouseEnter={handleMouseEnter}\n        onClick={handleClick}\n        {...divProps}\n        ref={divRef}\n      >\n        {children}\n      </div>\n    );\n  }\n);\n\nfunction useHighlightedIndex(): [\n  number,\n  React.Dispatch<React.SetStateAction<number>>,\n] {\n  const context = React.useContext(HighlightedIndexContext);\n  if (context === null) {\n    throw new Error(\n      \"useHighlightedIndex must be used within a HighlightedIndexProvider\"\n    );\n  }\n  return context;\n}\n\nfunction useSuggestions(): string[] {\n  const suggestions = useContext(SuggestionsContext);\n  if (suggestions === null) {\n    throw new Error(\"useSuggestions: SuggestionsContext not found\");\n  }\n\n  return suggestions;\n}\n\nfunction useOnValueSelectCallback(): (value: string) => void {\n  const onValueSelect = useContext(OnValueSelectCallbackContext);\n  if (onValueSelect === null) {\n    throw new Error(\"useOnValueSelectCallback: OnValueSelectContext not found\");\n  }\n\n  return onValueSelect;\n}\n\nfunction useOnResetMatchCallback(): () => void {\n  const onResetMatch = useContext(OnResetMatchCallbackContext);\n  if (onResetMatch === null) {\n    throw new Error(\"useOnResetMatchCallback: OnResetMatchContext not found\");\n  }\n\n  return onResetMatch;\n}\n\nexport { Item, List };\n"],"names":["React","Item"],"mappings":";;;;AAyBa,MAAA,kBAAA,GAAqB,cAA+B,IAAI,EAAA;AAExD,MAAA,4BAAA,GAA+B,cAE1C,IAAI,EAAA;AAEC,MAAM,2BAA8B,GAAA,aAAA;AAAA,EACzC,IAAA;AACF,EAAA;AAEA,MAAM,uBAAA,GAA0B,cAE9B,IAAI,CAAA,CAAA;AAMN,MAAM,IAAO,GAAA,UAAA;AAAA,EACX,SAAU,OAAO,YAAc,EAAA;AAC7B,IAAM,MAAA,EAAE,QAAa,EAAA,GAAA,QAAA,EAAa,GAAA,KAAA,CAAA;AAClC,IAAM,MAAA,CAAC,MAAM,CAAA,GAAI,yBAA0B,EAAA,CAAA;AAC3C,IAAA,MAAM,CAAC,gBAAA,EAAkB,mBAAmB,CAAA,GAAI,SAAS,CAAC,CAAA,CAAA;AAC1D,IAAA,MAAM,SAAS,cAAe,EAAA,CAAA;AAC9B,IAAA,MAAM,gBAAgB,wBAAyB,EAAA,CAAA;AAC/C,IAAA,MAAM,kBAAkB,uBAAwB,EAAA,CAAA;AAEhD,IAAA,SAAA,CAAU,MAAM;AACd,MAAA,SAAS,eAAe,KAA+B,EAAA;AACrD,QAAA,IAAI,OAAO,MAAW,KAAA,CAAA;AAAG,UAAO,OAAA,IAAA,CAAA;AAChC,QAAA,IAAI,gBAAqB,KAAA,IAAA;AAAM,UAAO,OAAA,IAAA,CAAA;AAGtC,QAAA,MAAM,YACJ,gBAAqB,KAAA,MAAA,CAAO,MAAS,GAAA,CAAA,GAAI,IAAI,gBAAmB,GAAA,CAAA,CAAA;AAClE,QAAA,mBAAA,CAAoB,SAAS,CAAA,CAAA;AAE7B,QAAA,KAAA,CAAM,cAAe,EAAA,CAAA;AACrB,QAAA,KAAA,CAAM,wBAAyB,EAAA,CAAA;AAE/B,QAAO,OAAA,IAAA,CAAA;AAAA,OACT;AAEA,MAAA,OAAO,MAAO,CAAA,eAAA;AAAA,QACZ,sBAAA;AAAA,QACA,cAAA;AAAA,QACA,oBAAA;AAAA,OACF,CAAA;AAAA,KACC,EAAA,CAAC,MAAQ,EAAA,gBAAA,EAAkB,MAAM,CAAC,CAAA,CAAA;AAErC,IAAA,SAAA,CAAU,MAAM;AACd,MAAA,SAAS,aAAa,KAA+B,EAAA;AACnD,QAAA,IAAI,OAAO,MAAW,KAAA,CAAA;AAAG,UAAO,OAAA,IAAA,CAAA;AAChC,QAAA,IAAI,gBAAqB,KAAA,IAAA;AAAM,UAAO,OAAA,IAAA,CAAA;AAGtC,QAAA,MAAM,YACJ,gBAAqB,KAAA,CAAA,GAAI,MAAO,CAAA,MAAA,GAAS,IAAI,gBAAmB,GAAA,CAAA,CAAA;AAClE,QAAA,mBAAA,CAAoB,SAAS,CAAA,CAAA;AAE7B,QAAA,KAAA,CAAM,cAAe,EAAA,CAAA;AACrB,QAAA,KAAA,CAAM,wBAAyB,EAAA,CAAA;AAC/B,QAAO,OAAA,IAAA,CAAA;AAAA,OACT;AAEA,MAAA,OAAO,MAAO,CAAA,eAAA;AAAA,QACZ,oBAAA;AAAA,QACA,YAAA;AAAA,QACA,oBAAA;AAAA,OACF,CAAA;AAAA,KACC,EAAA,CAAC,MAAQ,EAAA,gBAAA,EAAkB,MAAM,CAAC,CAAA,CAAA;AAErC,IAAA,SAAA,CAAU,MAAM;AACd,MAAA,SAAS,YAAY,KAA+B,EAAA;AAClD,QAAA,KAAA,CAAM,cAAe,EAAA,CAAA;AACrB,QAAA,KAAA,CAAM,wBAAyB,EAAA,CAAA;AAE/B,QAAgB,eAAA,EAAA,CAAA;AAChB,QAAO,OAAA,IAAA,CAAA;AAAA,OACT;AAEA,MAAA,OAAO,MAAO,CAAA,eAAA;AAAA,QACZ,kBAAA;AAAA,QACA,WAAA;AAAA,QACA,oBAAA;AAAA,OACF,CAAA;AAAA,KACC,EAAA,CAAC,MAAQ,EAAA,eAAe,CAAC,CAAA,CAAA;AAE5B,IAAA,SAAA,CAAU,MAAM;AACd,MAAA,SAAS,WAAW,KAAsC,EAAA;AACxD,QAAA,IAAI,OAAO,MAAW,KAAA,CAAA;AAAG,UAAO,OAAA,IAAA,CAAA;AAEhC,QAAA,aAAA,CAAc,OAAO,gBAAiB,CAAA,CAAA,CAAA;AAEtC,QAAA,IAAI,KAAU,KAAA,IAAA;AAAM,UAAO,OAAA,IAAA,CAAA;AAE3B,QAAA,KAAA,CAAM,cAAe,EAAA,CAAA;AACrB,QAAA,KAAA,CAAM,wBAAyB,EAAA,CAAA;AAC/B,QAAO,OAAA,IAAA,CAAA;AAAA,OACT;AAEA,MAAA,OAAO,MAAO,CAAA,eAAA;AAAA,QACZ,iBAAA;AAAA,QACA,UAAA;AAAA,QACA,oBAAA;AAAA,OACF,CAAA;AAAA,OACC,CAAC,MAAA,EAAQ,aAAe,EAAA,gBAAA,EAAkB,MAAM,CAAC,CAAA,CAAA;AAEpD,IAAA,SAAA,CAAU,MAAM;AACd,MAAM,MAAA,IAAA,GAAO,OAAO,cAAe,EAAA,CAAA;AACnC,MAAA,IAAI,IAAS,KAAA,IAAA;AAAM,QAAA,OAAA;AAEnB,MAAK,IAAA,CAAA,YAAA;AAAA,QACH,uBAAA;AAAA,QACA,CAAkB,eAAA,EAAA,gBAAA,CAAA,CAAA;AAAA,OACpB,CAAA;AAEA,MAAA,OAAO,MAAM;AACX,QAAA,IAAA,CAAK,gBAAgB,uBAAuB,CAAA,CAAA;AAAA,OAC9C,CAAA;AAAA,KACC,EAAA,CAAC,MAAQ,EAAA,gBAAgB,CAAC,CAAA,CAAA;AAE7B,IACE,uBAAAA,cAAA,CAAA,aAAA,CAAC,wBAAwB,QAAxB,EAAA;AAAA,MACC,KAAA,EAAO,CAAC,gBAAA,EAAkB,mBAAmB,CAAA;AAAA,KAAA,kBAE5CA,cAAA,CAAA,aAAA,CAAA,KAAA,EAAA;AAAA,MAAI,IAAK,EAAA,SAAA;AAAA,MAAW,GAAG,QAAA;AAAA,MAAU,GAAK,EAAA,YAAA;AAAA,KAAA,EACpC,QACH,CACF,CAAA,CAAA;AAAA,GAEJ;AACF,EAAA;AAMA,MAAM,IAAO,GAAA,UAAA;AAAA,EACX,SAASC,KAAK,CAAA,KAAA,EAAO,YAAc,EAAA;AACjC,IAAA,MAAM,EAAE,QAAU,EAAA,KAAA,EAAO,YAAc,EAAA,OAAA,EAAA,GAAY,UAAa,GAAA,KAAA,CAAA;AAChE,IAAM,MAAA,MAAA,GAAS,OAAuB,IAAI,CAAA,CAAA;AAE1C,IAAA,MAAM,CAAC,gBAAA,EAAkB,mBAAmB,CAAA,GAAI,mBAAoB,EAAA,CAAA;AACpE,IAAA,MAAM,cAAc,cAAe,EAAA,CAAA;AACnC,IAAA,MAAM,gBAAgB,wBAAyB,EAAA,CAAA;AAE/C,IAAM,MAAA,aAAA,GAAgB,YAAY,gBAAsB,CAAA,KAAA,KAAA,CAAA;AAExD,IAAA,mBAAA;AAAA,MACE,YAAA;AAAA,MACA,MAAM,MAAO,CAAA,OAAA;AAAA,KACf,CAAA;AAEA,IAAA,SAAA,CAAU,MAAM;AACd,MAAA,IAAI,CAAC,aAAA;AAAe,QAAA,OAAA;AAEpB,MAAA,MAAM,MAAM,MAAO,CAAA,OAAA,CAAA;AACnB,MAAA,IAAI,GAAQ,KAAA,IAAA;AAAM,QAAA,OAAA;AAElB,MAAA,GAAA,CAAI,cAAe,CAAA,EAAE,KAAO,EAAA,SAAA,EAAW,CAAA,CAAA;AAAA,KACzC,EAAG,CAAC,aAAa,CAAC,CAAA,CAAA;AAElB,IAAA,SAAS,iBAAiB,KAAmC,EAAA;AAC3D,MAAA,YAAA,GAAe,KAAK,CAAA,CAAA;AAEpB,MAAA,IAAI,MAAM,kBAAmB,EAAA;AAAG,QAAA,OAAA;AAEhC,MAAM,MAAA,KAAA,GAAQ,WAAY,CAAA,OAAA,CAAQ,KAAK,CAAA,CAAA;AACvC,MAAA,IAAI,KAAU,KAAA,CAAA,CAAA;AAAI,QAAA,OAAA;AAElB,MAAA,mBAAA,CAAoB,KAAK,CAAA,CAAA;AAAA,KAC3B;AAEA,IAAA,SAAS,YAAY,KAAmC,EAAA;AACtD,MAAA,OAAA,GAAU,KAAK,CAAA,CAAA;AAEf,MAAA,IAAI,MAAM,kBAAmB,EAAA;AAAG,QAAA,OAAA;AAEhC,MAAA,aAAA,CAAc,KAAK,CAAA,CAAA;AAAA,KACrB;AAEA,IAAA,uBACGD,cAAA,CAAA,aAAA,CAAA,KAAA,EAAA;AAAA,MACC,IAAK,EAAA,QAAA;AAAA,MACL,oBAAkB,aAAiB,IAAA,KAAA,CAAA;AAAA,MACnC,YAAc,EAAA,gBAAA;AAAA,MACd,OAAS,EAAA,WAAA;AAAA,MACR,GAAG,QAAA;AAAA,MACJ,GAAK,EAAA,MAAA;AAAA,KAAA,EAEJ,QACH,CAAA,CAAA;AAAA,GAEJ;AACF,EAAA;AAEA,SAAS,mBAGP,GAAA;AACA,EAAM,MAAA,OAAA,GAAUA,cAAM,CAAA,UAAA,CAAW,uBAAuB,CAAA,CAAA;AACxD,EAAA,IAAI,YAAY,IAAM,EAAA;AACpB,IAAA,MAAM,IAAI,KAAA;AAAA,MACR,oEAAA;AAAA,KACF,CAAA;AAAA,GACF;AACA,EAAO,OAAA,OAAA,CAAA;AACT,CAAA;AAEA,SAAS,cAA2B,GAAA;AAClC,EAAM,MAAA,WAAA,GAAc,WAAW,kBAAkB,CAAA,CAAA;AACjD,EAAA,IAAI,gBAAgB,IAAM,EAAA;AACxB,IAAM,MAAA,IAAI,MAAM,8CAA8C,CAAA,CAAA;AAAA,GAChE;AAEA,EAAO,OAAA,WAAA,CAAA;AACT,CAAA;AAEA,SAAS,wBAAoD,GAAA;AAC3D,EAAM,MAAA,aAAA,GAAgB,WAAW,4BAA4B,CAAA,CAAA;AAC7D,EAAA,IAAI,kBAAkB,IAAM,EAAA;AAC1B,IAAM,MAAA,IAAI,MAAM,0DAA0D,CAAA,CAAA;AAAA,GAC5E;AAEA,EAAO,OAAA,aAAA,CAAA;AACT,CAAA;AAEA,SAAS,uBAAsC,GAAA;AAC7C,EAAM,MAAA,YAAA,GAAe,WAAW,2BAA2B,CAAA,CAAA;AAC3D,EAAA,IAAI,iBAAiB,IAAM,EAAA;AACzB,IAAM,MAAA,IAAI,MAAM,wDAAwD,CAAA,CAAA;AAAA,GAC1E;AAEA,EAAO,OAAA,YAAA,CAAA;AACT;;;;"}