{"version":3,"file":"mention-plugin.js","sources":["../../src/mentions/mention-plugin.tsx"],"sourcesContent":["import {\n  autoUpdate,\n  flip,\n  hide,\n  limitShift,\n  offset,\n  shift,\n  size,\n  useFloating,\n} from \"@floating-ui/react-dom\";\nimport { useLexicalComposerContext } from \"@lexical/react/LexicalComposerContext\";\nimport { kInternal } from \"@liveblocks/core\";\nimport { useRoom } from \"@liveblocks/react\";\nimport { useMentionSuggestions } from \"@liveblocks/react-ui\";\nimport type { EditorState, NodeKey, NodeMutation, TextNode } from \"lexical\";\nimport {\n  $createRangeSelection,\n  $createTextNode,\n  $getNodeByKey,\n  $getSelection,\n  $isElementNode,\n  $isNodeSelection,\n  $isRangeSelection,\n  $isTextNode,\n  $setSelection,\n  COMMAND_PRIORITY_LOW,\n  KEY_BACKSPACE_COMMAND,\n} from \"lexical\";\nimport type { ReactNode } from \"react\";\nimport React, {\n  useCallback,\n  useEffect,\n  useLayoutEffect,\n  useState,\n} from \"react\";\nimport { createPortal } from \"react-dom\";\n\nimport { Avatar } from \"./avatar\";\nimport {\n  $createMentionNode,\n  $isMentionNode,\n  MentionNode,\n} from \"./mention-node\";\nimport * as Suggestions from \"./suggestions\";\nimport {\n  OnResetMatchCallbackContext,\n  OnValueSelectCallbackContext,\n  SuggestionsContext,\n} from \"./suggestions\";\nimport { User } from \"./user\";\n\nconst MENTION_TRIGGER = \"@\";\n\nconst PUNCTUATIONS =\n  \"\\\\.,\\\\+\\\\*\\\\?\\\\$\\\\@\\\\|#{}\\\\(\\\\)\\\\^\\\\-\\\\[\\\\]\\\\\\\\/!%'\\\"~=<>_:;\";\n\n// Characters we expect to see in a mention (non-space, non-punctuation).\nconst VALID_CHARACTERS = \"[^\" + MENTION_TRIGGER + PUNCTUATIONS + \"\\\\s]\";\n\nconst VALID_JOINS =\n  \"(?:\" +\n  \"\\\\.[ |$]|\" + // E.g. \"r. \" in \"Mr. Smith\"\n  \" |\" + // E.g. \" \" in \"Josh Duck\"\n  \"[\" +\n  PUNCTUATIONS +\n  \"]|\" + // E.g. \"-' in \"Salier-Hellendag\"\n  \")\";\n\nconst LENGTH_LIMIT = 75;\n\nconst MentionRegex = new RegExp(\n  \"(^|\\\\s|\\\\()(\" +\n    \"[\" +\n    MENTION_TRIGGER +\n    \"]\" +\n    \"((?:\" +\n    VALID_CHARACTERS +\n    VALID_JOINS +\n    \"){0,\" +\n    LENGTH_LIMIT +\n    \"})\" +\n    \")$\"\n);\n\nfunction $getAnchorNodeTextContent(): string | null {\n  const selection = $getSelection();\n  if (!$isRangeSelection(selection)) return null;\n\n  const anchor = selection.anchor;\n  if (anchor.type !== \"text\") return null;\n  const anchorNode = anchor.getNode();\n  if (!anchorNode.isSimpleText()) return null;\n  const anchorOffset = anchor.offset;\n  return anchorNode.getTextContent().slice(0, anchorOffset);\n}\n\n/**\n * Walk backwards along user input and forward through entity title to try and replace more of the user's text with entity.\n */\nfunction getFullMatchOffset(\n  documentText: string,\n  entryText: string,\n  offset: number\n): number {\n  let triggerOffset = offset;\n  for (let i = triggerOffset; i <= entryText.length; i++) {\n    if (documentText.substr(-i) === entryText.substr(0, i)) {\n      triggerOffset = i;\n    }\n  }\n  return triggerOffset;\n}\n\nfunction $isCurrentSelectionAtBoundary(offset: number): boolean {\n  // If the offset is not zero, i.e. not at the beginning of the text node, the selection is somewhere in the middle of the entity, i.e. not at the boundary.\n  if (offset !== 0) return false;\n\n  // Othewise (if the offset is zero), it means the selection could be at the start of an entity. It could also be at the end of the previous entity, or it could be in a position where there are no entities at all.\n  // So, we check if the previous sibling of the node at the anchor of the selection is a text entity. If it is, then the selection is at the boundary of the entity.\n  const selection = $getSelection();\n\n  if (!$isRangeSelection(selection)) return false;\n\n  const anchor = selection.anchor.getNode();\n  const prevSibling = anchor.getPreviousSibling();\n\n  if (!$isTextNode(prevSibling)) return false;\n  if (!prevSibling.isTextEntity()) return false;\n\n  return true;\n}\n\nfunction $getRangeAtMatch(match: RegExpExecArray): globalThis.Range | null {\n  const offsetWithWhitespaces = match.index + match[1].length;\n\n  if ($isCurrentSelectionAtBoundary(offsetWithWhitespaces)) return null;\n\n  const selection = window.getSelection();\n  if (selection === null) return null;\n  if (!selection.isCollapsed) return null;\n\n  const anchor = selection.anchorNode;\n  if (anchor === null) return null;\n\n  const endOffset = selection.anchorOffset;\n  if (endOffset === null) return null;\n\n  const range = document.createRange();\n\n  try {\n    range.setStart(anchor, offsetWithWhitespaces);\n    range.setEnd(anchor, endOffset);\n    return range;\n  } catch (error) {\n    return null;\n  }\n}\n\nexport function MentionPlugin() {\n  const [editor] = useLexicalComposerContext();\n\n  const [match, setMatch] = useState<RegExpExecArray | null>(null); // Represents the current match of the mention regex. A `null` value means there is no match.\n  const matchingString = match?.[3];\n\n  const suggestions = useMentionSuggestions(matchingString);\n\n  const room = useRoom();\n\n  useEffect(() => {\n    function $handleMutation(\n      mutations: Map<NodeKey, NodeMutation>,\n      {\n        prevEditorState,\n      }: {\n        prevEditorState: EditorState;\n      }\n    ) {\n      for (const [key, mutation] of mutations) {\n        if (mutation === \"created\") {\n          editor.getEditorState().read(() => {\n            const node = $getNodeByKey(key);\n            if (node === null) return;\n\n            if (!$isMentionNode(node)) return;\n\n            room[kInternal]\n              .createTextMention(node.getUserId(), node.getId())\n              .catch((err) => {\n                // TODO: Handle error\n                console.error(err);\n              });\n          });\n        } else if (mutation === \"destroyed\") {\n          prevEditorState.read(() => {\n            const node = $getNodeByKey(key);\n            if (node === null) return;\n\n            if (!$isMentionNode(node)) return;\n\n            room[kInternal].deleteTextMention(node.getId()).catch((err) => {\n              // TODO: Handle error\n              console.error(err);\n            });\n          });\n        }\n      }\n    }\n\n    return editor.registerMutationListener(\n      MentionNode,\n      (mutations, payload) => {\n        // Ignore mutations to MentionNode (creation/updates/deletions) that are caused by collaboration (remote users) or history merge.\n        if (\n          payload.updateTags.has(\"collaboration\") ||\n          payload.updateTags.has(\"history-merge\")\n        ) {\n          return;\n        }\n\n        $handleMutation(mutations, payload);\n      }\n    );\n  }, [editor, room]);\n\n  useEffect(() => {\n    function $onStateRead() {\n      const text = $getAnchorNodeTextContent();\n      if (text === null) {\n        setMatch(null);\n        return;\n      }\n\n      const match = MentionRegex.exec(text);\n      setMatch(match);\n    }\n\n    return editor.registerUpdateListener(({ editorState: state }) => {\n      state.read($onStateRead);\n    });\n  }, [editor]);\n\n  useEffect(() => {\n    function $handleBackspace(event: KeyboardEvent): boolean {\n      const selection = $getSelection();\n\n      if (selection === null) return false;\n\n      // If the selection is a node selection and the only node selected is a mention node, then we replace the mention node with a text node containing \"@\" and set the selection at the end of the text node.\n      if ($isNodeSelection(selection)) {\n        const nodes = selection.getNodes();\n        if (nodes.length !== 1) return false;\n\n        const node = nodes[0];\n        if (!$isMentionNode(node)) return false;\n\n        const text = $createTextNode(\"@\");\n        node.replace(text);\n\n        const newSelection = $createRangeSelection();\n        newSelection.setTextNodeRange(text, 1, text, 1);\n        $setSelection(newSelection);\n\n        event.preventDefault();\n        return true;\n      } else if ($isRangeSelection(selection)) {\n        if (!selection.isCollapsed()) return false;\n\n        const anchor = selection.anchor.getNode();\n        const prevSibling = anchor.getPreviousSibling();\n        if (selection.anchor.offset === 0 && $isMentionNode(prevSibling)) {\n          const text = $createTextNode(\"@\");\n          prevSibling.replace(text);\n\n          const newSelection = $createRangeSelection();\n          newSelection.setTextNodeRange(text, 1, text, 1);\n          $setSelection(newSelection);\n\n          event.preventDefault();\n          return true;\n        } else if ($isElementNode(anchor)) {\n          const child = anchor.getChildAtIndex(selection.anchor.offset - 1);\n          if (!$isMentionNode(child)) return false;\n\n          const text = $createTextNode(\"@\");\n          child.replace(text);\n\n          const newSelection = $createRangeSelection();\n          newSelection.setTextNodeRange(text, 1, text, 1);\n          $setSelection(newSelection);\n\n          event.preventDefault();\n          return true;\n        }\n\n        return false;\n      }\n\n      return false;\n    }\n\n    return editor.registerCommand(\n      KEY_BACKSPACE_COMMAND,\n      $handleBackspace,\n      COMMAND_PRIORITY_LOW\n    );\n  }, [editor]);\n\n  const handleValueSelect = useCallback(\n    (userId: string) => {\n      function $onValueSelect() {\n        if (match === null) return;\n\n        setMatch(null);\n\n        const selection = $getSelection();\n\n        if (!$isRangeSelection(selection)) return;\n        if (!selection.isCollapsed()) return;\n\n        const anchor = selection.anchor;\n        if (anchor.type !== \"text\") return;\n\n        const anchorNode: TextNode = anchor.getNode();\n        if (!anchorNode.isSimpleText()) return;\n\n        const selectionOffset = anchor.offset;\n        const text = anchorNode.getTextContent().slice(0, selectionOffset);\n\n        const characterOffset = match[2].length;\n        const queryOffset = getFullMatchOffset(text, match[2], characterOffset);\n        const startOffset = selectionOffset - queryOffset;\n        if (startOffset < 0) return;\n\n        const mentionNode = $createMentionNode(userId);\n\n        // Split the anchor (text) node and create a new text node only containing matched text.\n        if (startOffset === 0) {\n          const [node] = anchorNode.splitText(selectionOffset);\n          node.replace(mentionNode);\n        } else {\n          const [, node] = anchorNode.splitText(startOffset, selectionOffset);\n          node.replace(mentionNode);\n        }\n      }\n\n      editor.update($onValueSelect);\n    },\n    [editor, match]\n  );\n\n  if (match === null || matchingString === undefined) return null;\n\n  if (suggestions === undefined || suggestions.length === 0) return null;\n\n  const range = editor.getEditorState().read(() => $getRangeAtMatch(match));\n\n  if (range === null) return null;\n\n  return createPortal(\n    <SuggestionsContext.Provider value={suggestions}>\n      <OnValueSelectCallbackContext.Provider value={handleValueSelect}>\n        <OnResetMatchCallbackContext.Provider value={() => setMatch(null)}>\n          <SuggestionsPortal\n            range={range}\n            container={document.body}\n            key={matchingString}\n          >\n            <Suggestions.List className=\"lb-lexical-suggestions-list lb-lexical-mention-suggestions-list\">\n              {suggestions.map((userId) => (\n                <Suggestions.Item\n                  key={userId}\n                  value={userId}\n                  className=\"lb-lexical-suggestions-list-item lb-lexical-mention-suggestion\"\n                >\n                  <Avatar\n                    userId={userId}\n                    className=\"lb-lexical-mention-suggestion-avatar\"\n                  />\n                  <User\n                    userId={userId}\n                    className=\"lb-lexical-mention-suggestion-user\"\n                  />\n                </Suggestions.Item>\n              ))}\n            </Suggestions.List>\n          </SuggestionsPortal>\n        </OnResetMatchCallbackContext.Provider>\n      </OnValueSelectCallbackContext.Provider>\n    </SuggestionsContext.Provider>,\n    document.body\n  );\n}\n\nexport const SUGGESTIONS_COLLISION_PADDING = 10;\n\nfunction SuggestionsPortal({\n  children,\n  range,\n  container,\n}: {\n  children: ReactNode;\n  range: Range;\n  container: Element;\n}) {\n  const {\n    refs: { setReference, setFloating },\n    strategy,\n    x,\n    y,\n  } = useFloating({\n    strategy: \"fixed\",\n    placement: \"top-start\",\n    middleware: [\n      flip({ padding: SUGGESTIONS_COLLISION_PADDING, crossAxis: false }),\n      offset(10),\n      hide({ padding: SUGGESTIONS_COLLISION_PADDING }),\n      shift({ padding: SUGGESTIONS_COLLISION_PADDING, limiter: limitShift() }),\n      size({ padding: SUGGESTIONS_COLLISION_PADDING }),\n    ],\n    whileElementsMounted: (...args) => {\n      return autoUpdate(...args, {\n        animationFrame: true,\n      });\n    },\n  });\n\n  useLayoutEffect(() => {\n    setReference({\n      getBoundingClientRect: () => range.getBoundingClientRect(),\n    });\n  }, [setReference, range]);\n\n  return createPortal(\n    <div\n      ref={setFloating}\n      style={{\n        position: strategy,\n        top: 0,\n        left: 0,\n        transform: `translate3d(${Math.round(x)}px, ${Math.round(y)}px, 0)`,\n        minWidth: \"max-content\",\n      }}\n      className=\"lb-root lb-portal lb-elevation lb-lexical-suggestions lb-lexical-mention-suggestions\"\n    >\n      {children}\n    </div>,\n    container\n  );\n}\n"],"names":["$getSelection","$isRangeSelection","offset","$isTextNode","useLexicalComposerContext","useState","suggestions","useMentionSuggestions","useRoom","useEffect","$getNodeByKey","$isMentionNode","kInternal","MentionNode","match","$isNodeSelection","$createTextNode","$createRangeSelection","$setSelection","$isElementNode","KEY_BACKSPACE_COMMAND","COMMAND_PRIORITY_LOW","useCallback","mentionNode","$createMentionNode","createPortal","SuggestionsContext","OnValueSelectCallbackContext","OnResetMatchCallbackContext","Suggestions.List","Suggestions.Item","Avatar","User","useFloating","flip","hide","shift","limitShift","size","autoUpdate","useLayoutEffect"],"mappings":"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"}